import time
from typing import List, Dict
import streamlit as st
from openai import OpenAI

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê¸°ë³¸ í˜ì´ì§€ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="ğŸ“ˆ Buffett-Style AI Investment Copilot",
    page_icon="ğŸ¦«",
    layout="wide"
)

# íˆì–´ë¡œ/ì‚¬ì´ë“œë°” ì´ë¯¸ì§€(ì›í•˜ë©´ ë¡œì»¬ ê²½ë¡œë¡œ êµì²´)
HERO_IMG_URL = "https://images.unsplash.com/photo-1559526324-593bc073d938?q=80&w=1600"
SIDEBAR_LOGO_URL = "https://images.unsplash.com/photo-1542228262-3d663b306035?q=80&w=400"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Session State ì´ˆê¸°í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "messages" not in st.session_state:
    st.session_state.messages: List[Dict[str, str]] = []
if "system_prompt" not in st.session_state:
    st.session_state.system_prompt = (
        "ë„ˆëŠ” í•œêµ­ì–´ë¡œ ë‹µí•˜ëŠ” 'ì›Œë Œ ë²„í• ìŠ¤íƒ€ì¼ì˜ ê°€ì¹˜íˆ¬ì' ê¸ˆìœµíˆ¬ì ë¹„ì„œë‹¤. ë‹¤ìŒ ì›ì¹™ì„ ë°˜ë“œì‹œ ì§€ì¼œë¼.\n"
        "1) ë©´ì±…: ë„ˆì˜ ë‹µë³€ì€ ì¼ë°˜ ì •ë³´ ì œê³µì´ë©° íˆ¬ì ìë¬¸/ê¶Œìœ ê°€ ì•„ë‹ˆë‹¤. ìµœì¢… íŒë‹¨ê³¼ ì±…ì„ì€ ì‚¬ìš©ìì—ê²Œ ìˆìŒì„ ëª…í™•íˆ í•˜ë¼.\n"
        "2) í•µì‹¬ ì² í•™: ì•ˆì „ë§ˆì§„(margin of safety), í•´ì(moat), ì—­ëŸ‰ì˜ ë²”ìœ„(circle of competence), ì˜¤ë„ˆì´ìµ(owner earnings), "
        "ì¥ê¸°ë³´ìœ (long-term), í•©ë¦¬ì  ê°€ê²©, ë‹¨ìˆœÂ·ì˜ˆì¸¡ ê°€ëŠ¥í•œ ì‚¬ì—…, í˜„ê¸ˆíë¦„ì˜ ì§ˆì„ ì¤‘ì‹œí•˜ë¼.\n"
        "3) ë¶„ì„ êµ¬ì¡°(í•­ìƒ ìœ ì§€): (ìš”ì•½ 4~6ì¤„) â†’ (í•µì‹¬ ê·¼ê±° ë¶ˆë¦¿) â†’ (ì²´í¬ë¦¬ìŠ¤íŠ¸ í‘œ) â†’ (ë¦¬ìŠ¤í¬/ê°€ì •/ì¶”ê°€í™•ì¸) ìˆœì„œë¡œ ì œì‹œí•˜ë¼.\n"
        "4) ì²´í¬ë¦¬ìŠ¤íŠ¸: í•´ì/í˜„ê¸ˆíë¦„/ë¶€ì±„/ROIC/ìë³¸ë°°ë¶„/ê²½ì˜ì§„ ì •í•©ì„±/ê·œì œ/í™˜ìœ¨/ê¸ˆë¦¬ ë¯¼ê°ë„/ì‚¬ì´í´/ê±°ë²„ë„ŒìŠ¤/í¬ì„ ë¦¬ìŠ¤í¬.\n"
        "5) ìˆ˜ì¹˜ í‘œí˜„: ë‹¨ìœ„ë¥¼ ëª…í™•íˆ(%, KRW, USD ë“±). ê³„ì‚°Â·í‰ê°€ëª¨í˜• ê°€ì •ì€ ê°„ë‹¨íˆ ê³µê°œí•˜ë¼.\n"
        "6) ê³¼ë„í•œ í™•ì‹  ê¸ˆì§€: ë³´ìˆ˜/ê¸°ì¤€/ê³µê²© 3ê°€ì§€ ì‹œë‚˜ë¦¬ì˜¤ë¡œ ê°€ì • ê°’ì„ ë‚˜ëˆ„ì–´ ì œì‹œí•˜ë¼.\n"
        "7) ìµœì‹  ë°ì´í„° í•„ìš” ì‹œ 'ì¶”ì •'ì„ì„ í‘œì‹œí•˜ê³ , ì›ìë£Œ/ì¬ë¬´ì œí‘œ/10-K í™•ì¸ì„ ê¶Œê³ í•˜ë¼.\n"
    )
if "onboarding_open" not in st.session_state:
    # Trueë©´ ì²˜ìŒì— ì˜¨ë³´ë”© íŒ¨ë„ì„ ë³´ì—¬ì¤Œ(ì‚¬ìš©ìê°€ ë‹«ì„ ìˆ˜ ìˆìŒ)
    st.session_state.onboarding_open = True

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ìƒë‹¨ íƒ€ì´í‹€ & ë°°ë„ˆ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
left, right = st.columns([1, 2])
with left:
    st.title("ğŸ“ˆ Buffett-Style AI Investment Copilot")
    st.caption("AI ì—ì´ì „ì‹œìš© ê°€ì¹˜íˆ¬ì ë¹„ì„œ Â· ì €í‰ê°€/í˜„ê¸ˆíë¦„ ì¤‘ì‹¬ Â· í•´ì ì ê²€ Â· ë¦¬ìŠ¤í¬ ìš°ì„ ")
with right:
    st.image(HERO_IMG_URL, use_container_width=True, caption="Be fearful when others are greedy, and vice versa.")

st.divider()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì˜¨ë³´ë”© íŒ¨ë„ (ì²˜ìŒ í™”ë©´ì— ì‚¬ìš© ë°©ë²• í‘œì‹œ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def onboarding_panel():
    with st.container(border=True):
        st.subheader("ğŸš€ ì‹œì‘í•˜ê¸°: ì±—ë´‡ ì‚¬ìš© ë°©ë²•")
        st.markdown(
            """
**ì´ ì±—ë´‡ì€ ì›Œë Œ ë²„í•ì˜ ê°€ì¹˜íˆ¬ì ì›ì¹™**(ì•ˆì „ë§ˆì§„Â·í•´ìÂ·ì˜¤ë„ˆì´ìµ ë“±)ì„ ë‚´ì¥í•œ ê¸ˆìœµíˆ¬ì ë¹„ì„œì…ë‹ˆë‹¤.  
ì•„ë˜ ìˆœì„œëŒ€ë¡œ ì‹œì‘í•´ ë³´ì„¸ìš”.

**1) API í‚¤ ì…ë ¥**  
ì¢Œì¸¡ ì‚¬ì´ë“œë°” ë˜ëŠ” `secrets.toml`ì— OpenAI API í‚¤ë¥¼ ë„£ìŠµë‹ˆë‹¤.

**2) ì„¤ì • ì¡°ì •**  
- ëª¨ë¸ ì„ íƒ: `gpt-4o-mini` ê¶Œì¥(ë¹ ë¥´ê³  ê²½ì œì )  
- ì°½ì˜ì„±(temperature): 0.1~0.3 (ë³´ìˆ˜ì  ë¶„ì„ì— ìœ ë¦¬)  
- íˆ¬ì ì„±í–¥/ë³´ìœ ê¸°ê°„/ì§€ì—­/ì„¹í„°/ë¶„ì„ í†¤ì„ ê³ ë¥´ë©´ ë‹µë³€ì— ë°˜ì˜ë©ë‹ˆë‹¤.

**3) ì„¸ ê°€ì§€ í™œìš©ë²•**  
- **ğŸ§° Buffett Screener**: í‹°ì»¤ ì…ë ¥ â†’ í•´ì/í˜„ê¸ˆíë¦„/ROIC ë“± ì²´í¬ë¦¬ìŠ¤íŠ¸ + ê°„ë‹¨ ë°¸ë¥˜ì—ì´ì…˜ ìŠ¤ëƒ…ìƒ·  
- **ğŸ“ Investment Memo**: ë©”ëª¨ í…œí”Œë¦¿(Thesisâ†’Moatâ†’Owner Earningsâ†’Valuationâ†’Risksâ†’Catalystsâ†’Monitoringâ†’Verdict) ìë™ ìƒì„±  
- **ğŸ’¬ General Chat**: ììœ  ì§ˆì˜ì‘ë‹µ(ì˜ˆ: â€œë°°ë‹¹ ì„±ì¥ì£¼ 3ê°€ì§€ ì‹œë‚˜ë¦¬ì˜¤ë¡œ ì•ˆì „ë§ˆì§„ ê´€ì  ì •ë¦¬â€)

**4) ëŒ€í™” ê´€ë¦¬**  
- ì¢Œì¸¡ í•˜ë‹¨ **ğŸ§¹ ëŒ€í™” ì´ˆê¸°í™”**ë¡œ ê¸°ë¡ì„ ì§€ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
- ìƒ˜í”Œ í”„ë¡¬í”„íŠ¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°”ë¡œ ì‹œì‘í•´ë„ ì¢‹ì•„ìš”.

> âš ï¸ **ì¤‘ìš”**: ë³¸ ì±—ë´‡ì˜ ë‹µë³€ì€ ì¼ë°˜ ì •ë³´ ì œê³µì´ë©°, íˆ¬ì ìë¬¸/ê¶Œìœ ê°€ ì•„ë‹™ë‹ˆë‹¤.  
> ëª¨ë“  íˆ¬ì ê²°ì •ê³¼ ì±…ì„ì€ ì‚¬ìš©ìì—ê²Œ ìˆìœ¼ë©°, ì„¸ë¬´/ë²•ë¥ /íšŒê³„ ì´ìŠˆëŠ” ì „ë¬¸ê°€ì™€ ìƒì˜í•˜ì„¸ìš”.
"""
        )
        cols = st.columns([1,1,2,1])
        with cols[1]:
            if st.button("âœ… ì‹œì‘í•˜ê¸°", use_container_width=True):
                st.session_state.onboarding_open = False
                st.rerun()
        with cols[2]:
            if st.button("â„¹ï¸ ë‹¤ìŒì—ë„ ë³´ê¸°", use_container_width=True):
                # ë‹«ì§€ ì•Šê³  ìœ ì§€
                pass

# ì˜¨ë³´ë”© íŒ¨ë„ í‘œì‹œ(ì—´ë ¤ ìˆì„ ë•Œë§Œ)
if st.session_state.onboarding_open:
    onboarding_panel()
    st.stop()  # ì˜¨ë³´ë”©ë§Œ ë³´ì—¬ì£¼ê³  ì•„ë˜ UIëŠ” ì ì‹œ ë©ˆì¶¤

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# OpenAI Key (ì˜¨ë³´ë”© ì´í›„ í‘œì‹œ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
openai_api_key = st.secrets.get("OPENAI_API_KEY", "")
if not openai_api_key:
    openai_api_key = st.text_input("ğŸ”‘ OpenAI API Key", type="password", help="secrets.tomlì— OPENAI_API_KEYë¡œ ì €ì¥í•˜ë©´ ì…ë ¥ì°½ì´ ìˆ¨ê²¨ì ¸ìš”.")
if not openai_api_key:
    st.info("API í‚¤ë¥¼ ì…ë ¥í•˜ë©´ ì±—ë´‡ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", icon="ğŸ”’")
    st.stop()

client = OpenAI(api_key=openai_api_key)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì‚¬ì´ë“œë°”: ë¡œê³ /ì„¤ì •/ìƒ˜í”Œ/ì´ˆê¸°í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.image(SIDEBAR_LOGO_PATH, use_container_width=True)
    st.markdown("<h4 style='text-align:center; color:#F2D06B;'>Value Â· Moat Â· Cash Flow</h4>", unsafe_allow_html=True)
    st.header("âš™ï¸ ì„¤ì •")
    model = st.selectbox(
        "ëª¨ë¸ ì„ íƒ",
        ["gpt-4o-mini", "gpt-4o", "gpt-3.5-turbo"],
        index=0,
        help="ì¼ë°˜ì ìœ¼ë¡œ gpt-4o-miniê°€ ë¹ ë¥´ê³  ê²½ì œì ì…ë‹ˆë‹¤."
    )
    temperature = st.slider("ì°½ì˜ì„±(temperature)", 0.0, 1.0, 0.2, 0.1, help="ê°€ì¹˜íˆ¬ì ë¶„ì„ì€ ë‚®ì€ ê°’(ë³´ìˆ˜ì )ì´ ì¼ë°˜ì ")
    max_tokens = st.slider("ìµœëŒ€ ìƒì„± í† í°", 256, 4096, 1400, 128)

    st.subheader("ğŸ¯ íˆ¬ì ì„±í–¥ & ì¡°ê±´")
    risk_profile = st.radio("ë¦¬ìŠ¤í¬ ì„±í–¥", ["ë³´ìˆ˜ì ", "ì¤‘ë¦½", "ê³µê²©ì "], index=0, horizontal=True)
    horizon = st.selectbox("íˆ¬ì ë³´ìœ ê¸°ê°„", ["1~2ë…„", "3~5ë…„", "5~10ë…„+"], index=1)
    region = st.multiselect("ì§€ì—­", ["KR", "US", "JP", "EU", "EM"], default=["US", "KR"])
    sectors = st.multiselect("ì„¹í„°", ["Technology", "Financials", "Industrials", "Energy", "Healthcare", "Consumer", "Utilities", "Materials"], default=["Technology","Consumer"])

    st.subheader("ğŸ§  ì–´ì‹œìŠ¤í„´íŠ¸ í†¤")
    tone = st.radio("í†¤", ["ì¤‘ë¦½/ë³´ìˆ˜", "ì¤‘ë¦½/ê· í˜•", "ê¸°íšŒë°œêµ´"], index=1, horizontal=True)
    tone_line = {
        "ì¤‘ë¦½/ë³´ìˆ˜": "ì•ˆì „ë§ˆì§„ì„ ìµœìš°ì„ ìœ¼ë¡œ ì‚¼ê³ , ë¦¬ìŠ¤í¬ë¥¼ ë¨¼ì € ì‹ë³„/ì„œìˆ í•˜ë¼.",
        "ì¤‘ë¦½/ê· í˜•": "ê¸/ë¶€ì • ìš”ì¸ì„ ê· í˜•ìˆê²Œ ì œì‹œí•˜ë˜, í•µì‹¬ ë³€ìˆ˜ë¥¼ ê°•ì¡°í•˜ë¼.",
        "ê¸°íšŒë°œêµ´": "ì €í‰ê°€ êµ¬ê°„/ì¹´íƒˆë¦¬ìŠ¤íŠ¸ë¥¼ ì ê·¹ íƒìƒ‰í•˜ë˜, ë¦¬ìŠ¤í¬ ê²½ê³ ë¥¼ ëª…ì‹œí•˜ë¼."
    }[tone]

    st.subheader("âœï¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸(ì„ íƒ)")
    with st.expander("í¸ì§‘/ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ", expanded=False):
        edited = st.text_area("ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸", value=st.session_state.system_prompt, height=220)
        if st.button("ì ìš©"):
            st.session_state.system_prompt = edited
            st.success("ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì ìš© ì™„ë£Œ")

    # ì´ˆê¸°í™” ë²„íŠ¼
    if st.button("ğŸ§¹ ëŒ€í™” ì´ˆê¸°í™”"):
        st.session_state.messages = []
        st.success("ëŒ€í™”ë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.")
        st.rerun()

    # ìƒ˜í”Œ í”„ë¡¬í”„íŠ¸
    st.subheader("ğŸ’¡ ìƒ˜í”Œ í”„ë¡¬í”„íŠ¸")
    if st.button("â€¢ ë²„í• ìŠ¤í¬ë¦¬ë„ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¡œ AAPL ì ê²€"):
        st.session_state.messages.append({"role": "user", "content": "AAPLì„ ë²„í• ìŠ¤í¬ë¦¬ë„ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¡œ ì ê²€í•´ì¤˜."})
        st.rerun()
    if st.button("â€¢ ì†Œë¹„ì¬ ê¸°ì—… ì¸ë² ìŠ¤íŠ¸ë¨¼íŠ¸ ë©”ëª¨ í…œí”Œë¦¿"):
        st.session_state.messages.append({"role": "user", "content": "ì†Œë¹„ì¬ ê¸°ì—… í•˜ë‚˜ë¥¼ ê°€ì •í•˜ê³ , ë²„í• ìŠ¤íƒ€ì¼ ì¸ë² ìŠ¤íŠ¸ë¨¼íŠ¸ ë©”ëª¨ í…œí”Œë¦¿ì„ ì±„ì›Œì¤˜."})
        st.rerun()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë„ìš°ë¯¸: íˆìŠ¤í† ë¦¬ íŠ¸ë¦¬ë°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def trim_messages(messages: List[Dict[str, str]], max_pairs: int = 18) -> List[Dict[str, str]]:
    ua = [m for m in messages if m["role"] in ("user", "assistant")]
    if len(ua) <= 2 * max_pairs:
        return messages
    return ua[-2 * max_pairs :]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íƒ­: ë²„í• ìŠ¤í¬ë¦¬ë„ˆ / ì¸ë² ìŠ¤íŠ¸ë¨¼íŠ¸ ë©”ëª¨ / ì¼ë°˜ ì±—
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tab1, tab2, tab3 = st.tabs(["ğŸ§° Buffett Screener", "ğŸ“ Investment Memo", "ğŸ’¬ General Chat"])

with tab1:
    st.subheader("ğŸ§° ë²„í• ìŠ¤í¬ë¦¬ë„ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸")
    ticker = st.text_input("í‹°ì»¤/ê¸°ì—…ëª…", placeholder="ì˜ˆ: KO, AAPL, ì‚¼ì„±ì „ì, í˜„ëŒ€ëª¨ë¹„ìŠ¤")
    notes = st.text_area(
        "ì„ íƒ: ì°¸ê³  ë©”ëª¨/ìµœê·¼ ì‹¤ì  ìš”ì (ìˆìœ¼ë©´ ë¶™ì—¬ë„£ê¸°)",
        height=120,
        placeholder="ìµœê·¼ ë¶„ê¸° í•˜ì´ë¼ì´íŠ¸, ë§¤ì¶œ/ì˜ì—…ì´ìµ/FCF ì¶”ì„¸, ê°€ê²©ë ˆë²¨, ì´ìŠˆ ë“±"
    )
    if st.button("ìŠ¤í¬ë¦¬ë„ˆ ì‹¤í–‰"):
        user_prompt = f"""
ë‹¤ìŒ ê¸°ì—…ì„ 'ë²„í• ìŠ¤í¬ë¦¬ë„ˆ'ë¡œ ì ê²€í•´ì¤˜.
ê¸°ì—…: {ticker}
ì°¸ê³ ë©”ëª¨: {notes}

ì¶œë ¥ í˜•ì‹:
1) 5ì¤„ ìš”ì•½
2) í•µì‹¬ ê·¼ê±° bullet (í•´ì/í˜„ê¸ˆíë¦„/ë¶€ì±„/ROIC/ì˜¤ë„ˆì´ìµ/ê²½ì˜ì§„/ê·œì œ/í™˜ìœ¨Â·ê¸ˆë¦¬Â·ì‚¬ì´í´)
3) ì²´í¬ë¦¬ìŠ¤íŠ¸ í‘œ(í•­ëª©/í‰ê°€/ê°„ë‹¨ì´ìœ ) â€” í•´ì, í˜„ê¸ˆíë¦„ì˜ ì§ˆ, ë¶€ì±„Â·ì´ìë³´ìƒ, ìë³¸ë°°ë¶„, ê·œì œÂ·ì •ì±…, í™˜ìœ¨Â·ê¸ˆë¦¬ ë¯¼ê°ë„, ê±°ë²„ë„ŒìŠ¤, í¬ì„ë¦¬ìŠ¤í¬
4) ê°„ë‹¨ ë°¸ë¥˜ì—ì´ì…˜ ìŠ¤ëƒ…ìƒ·(ë³´ìˆ˜/ê¸°ì¤€/ê³µê²©) â€” ì‚¬ìš© ê°€ì •(ë©€í‹°í”Œ/DCF ë‹¨ìˆœ ê°€ì •)ê³¼ ê²°ê³¼ ë²”ìœ„(ê°€ê²© ë˜ëŠ” EV/EBIT ìˆ˜ì¤€)
5) ë¦¬ìŠ¤í¬/ì¶”ê°€í™•ì¸ ëª©ë¡

íˆ¬ì ì„±í–¥: {risk_profile}, ë³´ìœ ê¸°ê°„: {horizon}, ì§€ì—­: {', '.join(region)}, ì„¹í„° ì„ í˜¸: {', '.join(sectors)}
í†¤ ê°€ì´ë“œ: {tone_line}
"""
        st.session_state.messages.append({"role": "user", "content": user_prompt})
        st.rerun()

with tab2:
    st.subheader("ğŸ“ ë²„í• ìŠ¤íƒ€ì¼ Investment Memo í…œí”Œë¦¿")
    company = st.text_input("ê¸°ì—…/í‹°ì»¤", placeholder="ì˜ˆ: BRK.B, AAPL, MSFT, NVDA")
    memo_hints = st.text_area(
        "ì„ íƒ: ì¶”ê°€ íŒíŠ¸(ì œí’ˆ/í•´ì/ê°€ê²©ëŒ€/ì´ë²¤íŠ¸ ë“±)",
        height=120,
        placeholder="ì˜ˆ: ì½”ì¹´ì½œë¼ì˜ ë¸Œëœë“œ í•´ì, ì¬êµ¬ë§¤ìœ¨, ì›ì¬ë£ŒÂ·í™˜ìœ¨ ë¯¼ê°ë„, ì¬ë¬´ë ˆë²„ë¦¬ì§€ ë“±"
    )
    if st.button("ë©”ëª¨ ìƒì„±"):
        user_prompt = f"""
'{company}'ì— ëŒ€í•œ 'ë²„í• ìŠ¤íƒ€ì¼ Investment Memo'ë¥¼ ì‘ì„±í•´ì¤˜.
í…œí”Œë¦¿ ìš”êµ¬ì‚¬í•­:
- 1. Thesis(í•µì‹¬ ë…¼ì§€) â€” 4~6ì¤„
- 2. Business & Moat â€” ì œí’ˆ/ë¸Œëœë“œ/ë„¤íŠ¸ì›Œí¬/ê·œëª¨/ê·œì œ/ì „í™˜ë¹„ìš© ë“±
- 3. Unit Economics & Owner Earnings â€” ë§¤ì¶œ/ë§ˆì§„/CAPEX/FCF/ì˜¤ë„ˆì´ìµ ê°œë…
- 4. Capital Allocation â€” ë°°ë‹¹/ìì‚¬ì£¼/ì¸ìˆ˜/R&D, ROIC ì¶”ì„¸
- 5. Valuation â€” ë³´ìˆ˜/ê¸°ì¤€/ê³µê²© 3ê°€ì§€(ë©€í‹°í”Œ ë˜ëŠ” ê°„ì´ DCF) + ê°€ì •ì¹˜ ëª…ì‹œ
- 6. Risks â€” ê¸ˆë¦¬/í™˜ìœ¨/ê·œì œ/ì‚¬ì´í´/ê²½ìŸ/ê¸°ìˆ /í¬ì„/ì§€ë°°êµ¬ì¡°
- 7. Catalysts â€” ë¦¬í”„ë¼ì´ì‹± íŠ¸ë¦¬ê±°(ì‹ ì œí’ˆ/ì •ì±…/ê°€ê²©ì¸ìƒ/ì ìœ ìœ¨ ë“±)
- 8. Monitoring â€” ë¶„ê¸°ë³„ ì²´í¬ í¬ì¸íŠ¸
- 9. Verdict â€” ìš”ì•½ ì½”ë©˜íŠ¸(ê°€ì¹˜ ëŒ€ë¹„ ê°€ê²©, ì•ˆì „ë§ˆì§„ ê´€ì )

ì¶”ê°€ íŒíŠ¸: {memo_hints}
íˆ¬ì ì„±í–¥: {risk_profile}, ë³´ìœ ê¸°ê°„: {horizon}, ì§€ì—­: {', '.join(region)}, ì„¹í„° ì„ í˜¸: {', '.join(sectors)}
í†¤ ê°€ì´ë“œ: {tone_line}
"""
        st.session_state.messages.append({"role": "user", "content": user_prompt})
        st.rerun()

with tab3:
    st.subheader("ğŸ’¬ ì¼ë°˜ ëŒ€í™”")
    if len(st.session_state.messages) == 0:
        st.info("ë²„í• ì›ì¹™ìœ¼ë¡œ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”. ì˜ˆ) 'ë°°ë‹¹ ì„±ì¥ì£¼ 3ê°€ì§€ ì‹œë‚˜ë¦¬ì˜¤ë¡œ ì•ˆì „ë§ˆì§„ ê´€ì  ì •ë¦¬'")
    for msg in st.session_state.messages:
        with st.chat_message(msg["role"]):
            st.markdown(msg["content"])
    prompt = st.chat_input("ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? (ì˜ˆ: ETF ë¦¬ë°¸ëŸ°ì‹± ê·œì¹™ ì´ˆì•ˆ ë§Œë“¤ì–´ì¤˜)")
    if prompt:
        st.session_state.messages.append({"role": "user", "content": prompt})

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ëª¨ë¸ í˜¸ì¶œ (ìŠ¤íŠ¸ë¦¬ë°) â€” ë§ˆì§€ë§‰ ë©”ì‹œì§€ê°€ userë©´ ì‹¤í–‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def build_messages() -> List[Dict[str, str]]:
    system_full = st.session_state.system_prompt + "\n" + f"ì¶”ê°€ í†¤ ì§€ì‹œ: {tone_line}"
    history = trim_messages(st.session_state.messages, max_pairs=18)
    return [{"role": "system", "content": system_full}] + history

if st.session_state.messages and st.session_state.messages[-1]["role"] == "user":
    with st.chat_message("assistant"):
        placeholder = st.empty()
        try:
            stream = client.chat.completions.create(
                model=model,
                messages=[{"role": m["role"], "content": m["content"]} for m in build_messages()],
                temperature=temperature,
                max_tokens=max_tokens,
                stream=True,
            )
            response_text = st.write_stream(stream)
            st.session_state.messages.append({"role": "assistant", "content": response_text})
        except Exception as e:
            placeholder.error(f"ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í•˜ë‹¨ ì£¼ì˜ ë¬¸êµ¬
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.divider()
st.caption(
    "â€» ë³¸ ì±—ë´‡ì˜ ë‹µë³€ì€ ì¼ë°˜ ì •ë³´ ì œê³µ ëª©ì ì´ë©°, íˆ¬ì ìë¬¸ ë˜ëŠ” ê¶Œìœ ê°€ ì•„ë‹™ë‹ˆë‹¤. "
    "ëª¨ë“  íˆ¬ì ê²°ì •ê³¼ ì±…ì„ì€ ì‚¬ìš©ì ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤. ì„¸ë¬´/ë²•ë¥ /íšŒê³„ ì‚¬í•­ì€ ì „ë¬¸ê¸°ê´€ê³¼ ìƒì˜í•˜ì„¸ìš”."
)
