import os
import time
from typing import List, Dict
import streamlit as st
from openai import OpenAI

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê¸°ë³¸ í˜ì´ì§€ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="ğŸ“ˆ Buffett-Style AI Investment Copilot",
    page_icon="ğŸ¦«",
    layout="wide",
    initial_sidebar_state="expanded",
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì´ë¯¸ì§€ ê²½ë¡œ/URL & í´ë°± ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
HERO_IMG_PATH = "/mnt/data/32d37cf6-cb03-4500-ab21-08ee05047b34.png"  # ì£¼ì‹/ì°¨íŠ¸ ë¡œì»¬ ì´ë¯¸ì§€(ìˆìœ¼ë©´ ì‚¬ìš©)
HERO_IMG_FALLBACK = "https://images.unsplash.com/photo-1559526324-593bc073d938?q=80&w=1600"

SIDEBAR_LOGO_CANDIDATES = [
    "/mnt/data/7caadb76-f6de-44ce-875f-b736fa88f0a6.png",             # ë¡œì»¬ 1
    "/mnt/data/32d37cf6-cb03-4500-ab21-08ee05047b34.png",             # ë¡œì»¬ 2
    "https://images.unsplash.com/photo-1542228262-3d663b306035?q=80&w=400",  # URL 1
    "https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=400",  # URL 2
]

def show_sidebar_image():
    """ì‚¬ì´ë“œë°” ì´ë¯¸ì§€: ë¡œì»¬ â†’ URL â†’ ì´ëª¨ì§€ 3ë‹¨ í´ë°±"""
    for src in SIDEBAR_LOGO_CANDIDATES:
        try:
            if src.startswith("http"):
                st.image(src, use_container_width=True)
                return
            elif os.path.exists(src):
                st.image(src, use_container_width=True)
                return
        except Exception:
            continue
    st.markdown("<div style='text-align:center;font-size:44px;'>ğŸ“ˆ</div>", unsafe_allow_html=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Session State ì´ˆê¸°í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "messages" not in st.session_state:
    st.session_state.messages: List[Dict[str, str]] = []
if "system_prompt" not in st.session_state:
    st.session_state.system_prompt = (
        "ë„ˆëŠ” í•œêµ­ì–´ë¡œ ë‹µí•˜ëŠ” 'ì›Œë Œ ë²„í• ìŠ¤íƒ€ì¼ì˜ ê°€ì¹˜íˆ¬ì' ê¸ˆìœµíˆ¬ì ë¹„ì„œë‹¤. ë‹¤ìŒ ì›ì¹™ì„ ë°˜ë“œì‹œ ì§€ì¼œë¼.\n"
        "1) ë©´ì±…: ë„ˆì˜ ë‹µë³€ì€ ì¼ë°˜ ì •ë³´ ì œê³µì´ë©° íˆ¬ì ìë¬¸/ê¶Œìœ ê°€ ì•„ë‹ˆë‹¤. ìµœì¢… íŒë‹¨ê³¼ ì±…ì„ì€ ì‚¬ìš©ìì—ê²Œ ìˆìŒì„ ëª…í™•íˆ í•˜ë¼.\n"
        "2) í•µì‹¬ ì² í•™: ì•ˆì „ë§ˆì§„(margin of safety), í•´ì(moat), ì—­ëŸ‰ì˜ ë²”ìœ„(circle of competence), ì˜¤ë„ˆì´ìµ(owner earnings), "
        "ì¥ê¸°ë³´ìœ (long-term), í•©ë¦¬ì  ê°€ê²©, ë‹¨ìˆœÂ·ì˜ˆì¸¡ ê°€ëŠ¥í•œ ì‚¬ì—…, í˜„ê¸ˆíë¦„ì˜ ì§ˆì„ ì¤‘ì‹œí•˜ë¼.\n"
        "3) ë¶„ì„ êµ¬ì¡°(í•­ìƒ ìœ ì§€): (ìš”ì•½ 4~6ì¤„) â†’ (í•µì‹¬ ê·¼ê±° ë¶ˆë¦¿) â†’ (ì²´í¬ë¦¬ìŠ¤íŠ¸ í‘œ) â†’ (ë¦¬ìŠ¤í¬/ê°€ì •/ì¶”ê°€í™•ì¸) ìˆœì„œë¡œ ì œì‹œí•˜ë¼.\n"
        "4) ì²´í¬ë¦¬ìŠ¤íŠ¸: í•´ì/í˜„ê¸ˆíë¦„/ë¶€ì±„/ROIC/ìë³¸ë°°ë¶„/ê²½ì˜ì§„ ì •í•©ì„±/ê·œì œ/í™˜ìœ¨/ê¸ˆë¦¬ ë¯¼ê°ë„/ì‚¬ì´í´/ê±°ë²„ë„ŒìŠ¤/í¬ì„ ë¦¬ìŠ¤í¬.\n"
        "5) ìˆ˜ì¹˜ í‘œí˜„: ë‹¨ìœ„ë¥¼ ëª…í™•íˆ(%, KRW, USD ë“±). ê³„ì‚°Â·í‰ê°€ëª¨í˜• ê°€ì •ì€ ê°„ë‹¨íˆ ê³µê°œí•˜ë¼.\n"
        "6) ê³¼ë„í•œ í™•ì‹  ê¸ˆì§€: ë³´ìˆ˜/ê¸°ì¤€/ê³µê²© 3ê°€ì§€ ì‹œë‚˜ë¦¬ì˜¤ë¡œ ê°€ì • ê°’ì„ ë‚˜ëˆ„ì–´ ì œì‹œí•˜ë¼.\n"
        "7) ìµœì‹  ë°ì´í„° í•„ìš” ì‹œ 'ì¶”ì •'ì„ì„ í‘œì‹œí•˜ê³ , ì›ìë£Œ/ì¬ë¬´ì œí‘œ/10-K í™•ì¸ì„ ê¶Œê³ í•˜ë¼.\n"
    )
if "onboarding_open" not in st.session_state:
    st.session_state.onboarding_open = True

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ìƒë‹¨ íƒ€ì´í‹€ & ë°°ë„ˆ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
left, right = st.columns([1, 2])
with left:
    st.title("ğŸ“ˆ Buffett-Style AI Investment Copilot")
    st.caption("AI ì—ì´ì „ì‹œìš© ê°€ì¹˜íˆ¬ì ë¹„ì„œ Â· ì €í‰ê°€/í˜„ê¸ˆíë¦„ ì¤‘ì‹¬ Â· í•´ì ì ê²€ Â· ë¦¬ìŠ¤í¬ ìš°ì„ ")
with right:
    if os.path.exists(HERO_IMG_PATH):
        st.image(HERO_IMG_PATH, use_container_width=True, caption="Clarity first, price second.")
    else:
        st.image(HERO_IMG_FALLBACK, use_container_width=True, caption="Clarity first, price second.")

st.divider()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì˜¨ë³´ë”© íŒ¨ë„
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def onboarding_panel():
    with st.container(border=True):
        st.subheader("ğŸš€ ì‹œì‘í•˜ê¸°: ì±—ë´‡ ì‚¬ìš© ë°©ë²•")
        st.markdown(
            """
**ë²„í•ì˜ ê°€ì¹˜íˆ¬ì ì›ì¹™**(ì•ˆì „ë§ˆì§„Â·í•´ìÂ·ì˜¤ë„ˆì´ìµ ë“±)ì„ ë‚´ì¥í•œ ê¸ˆìœµíˆ¬ì ë¹„ì„œì…ë‹ˆë‹¤.  

**1) API í‚¤ ì…ë ¥**: ì‚¬ì´ë“œë°” ë˜ëŠ” `secrets.toml`  
**2) ì„¤ì •**: ëª¨ë¸ `gpt-4o-mini` ê¶Œì¥, temperature 0.1~0.3  
**3) ì£¼ìš” ê¸°ëŠ¥**  
- ğŸ§° Buffett Screener: ì²´í¬ë¦¬ìŠ¤íŠ¸ + ê°„ë‹¨ ë°¸ë¥˜  
- ğŸ“ Investment Memo: ë©”ëª¨ í…œí”Œë¦¿ ìë™ ìƒì„±  
- ğŸ’¬ General Chat: ììœ  ì§ˆì˜ì‘ë‹µ

> âš ï¸ ë³¸ ì±—ë´‡ ë‹µë³€ì€ ì¼ë°˜ ì •ë³´ ì œê³µì´ë©° íˆ¬ì ìë¬¸/ê¶Œìœ ê°€ ì•„ë‹™ë‹ˆë‹¤.
"""
        )
        cols = st.columns([1,1,2,1])
        with cols[1]:
            if st.button("âœ… ì‹œì‘í•˜ê¸°", use_container_width=True):
                st.session_state.onboarding_open = False
                st.rerun()
        with cols[2]:
            if st.button("â„¹ï¸ ë‹¤ìŒì—ë„ ë³´ê¸°", use_container_width=True):
                pass

if st.session_state.onboarding_open:
    onboarding_panel()
    st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# OpenAI Key
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
openai_api_key = st.secrets.get("OPENAI_API_KEY", "")
if not openai_api_key:
    openai_api_key = st.text_input("ğŸ”‘ OpenAI API Key", type="password", help="secrets.tomlì— OPENAI_API_KEYë¡œ ì €ì¥í•˜ë©´ ì…ë ¥ì°½ì´ ìˆ¨ê²¨ì ¸ìš”.")
if not openai_api_key:
    st.info("API í‚¤ë¥¼ ì…ë ¥í•˜ë©´ ì±—ë´‡ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", icon="ğŸ”’")
    st.stop()
client = OpenAI(api_key=openai_api_key)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì‚¬ì´ë“œë°”: ë¡œê³ /ì„¤ì •/ìƒ˜í”Œ/ì´ˆê¸°í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    show_sidebar_image()  # â† ê¹¨ì§ ë°©ì§€ í´ë°± ì ìš©
    st.markdown("<h4 style='text-align:center; color:#F2D06B; font-weight:800; letter-spacing:0.2px; margin:0.4rem 0;'>Value Â· Moat Â· Cash Flow</h4>", unsafe_allow_html=True)

    st.header("âš™ï¸ ì„¤ì •")
    model = st.selectbox("ëª¨ë¸ ì„ íƒ", ["gpt-4o-mini", "gpt-4o", "gpt-3.5-turbo"], index=0)
    temperature = st.slider("ì°½ì˜ì„±(temperature)", 0.0, 1.0, 0.2, 0.1)
    max_tokens = st.slider("ìµœëŒ€ ìƒì„± í† í°", 256, 4096, 1400, 128)

    st.subheader("ğŸ¯ íˆ¬ì ì„±í–¥ & ì¡°ê±´")
    risk_profile = st.radio("ë¦¬ìŠ¤í¬ ì„±í–¥", ["ë³´ìˆ˜ì ", "ì¤‘ë¦½", "ê³µê²©ì "], index=0, horizontal=True)
    horizon = st.selectbox("íˆ¬ì ë³´ìœ ê¸°ê°„", ["1~2ë…„", "3~5ë…„", "5~10ë…„+"], index=1)
    region = st.multiselect("ì§€ì—­", ["KR", "US", "JP", "EU", "EM"], default=["US", "KR"])
    sectors = st.multiselect("ì„¹í„°", ["Technology", "Financials", "Industrials", "Energy", "Healthcare", "Consumer", "Utilities", "Materials"], default=["Technology","Consumer"])

    st.subheader("ğŸ§  ì–´ì‹œìŠ¤í„´íŠ¸ í†¤")
    tone = st.radio("í†¤", ["ì¤‘ë¦½/ë³´ìˆ˜", "ì¤‘ë¦½/ê· í˜•", "ê¸°íšŒë°œêµ´"], index=1, horizontal=True)
    tone_line = {
        "ì¤‘ë¦½/ë³´ìˆ˜": "ì•ˆì „ë§ˆì§„ì„ ìµœìš°ì„ ìœ¼ë¡œ ì‚¼ê³ , ë¦¬ìŠ¤í¬ë¥¼ ë¨¼ì € ì‹ë³„/ì„œìˆ í•˜ë¼.",
        "ì¤‘ë¦½/ê· í˜•": "ê¸Â·ë¶€ì • ìš”ì¸ì„ ê· í˜• ìˆê²Œ ì œì‹œí•˜ë˜ í•µì‹¬ ë³€ìˆ˜ë¥¼ ê°•ì¡°í•˜ë¼.",
        "ê¸°íšŒë°œêµ´": "ì €í‰ê°€ êµ¬ê°„/ì¹´íƒˆë¦¬ìŠ¤íŠ¸ë¥¼ ì ê·¹ íƒìƒ‰í•˜ë˜ ë¦¬ìŠ¤í¬ ê²½ê³ ë¥¼ ëª…ì‹œí•˜ë¼."
    }[tone]

    st.subheader("âœï¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸(ì„ íƒ)")
    with st.e
